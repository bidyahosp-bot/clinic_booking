<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NCD Program – Bidiyah Hospital</title>
<style>
  body{font-family:Tahoma,Arial,sans-serif;background:#f4f7fa;text-align:center;direction:rtl;margin:0}
  header{background:#006699;color:#fff;padding:15px;font-weight:bold;font-size:18px}

  .wrap{max-width:980px;margin:0 auto;padding:10px}
  .stats{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin:10px 0}
  .statBox{background:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);min-width:190px}

  .months{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin:12px 0}
  @media (max-width:900px){ .months{grid-template-columns:1fr;} }

  .monthCard{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:12px}
  .monthTitle{font-weight:bold;margin:6px 0 10px 0;color:#0b3c55}

  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .hdr{background:#e6eef5;border-radius:8px;padding:8px 4px;font-weight:bold;font-size:13px}

  .cell{
    border:1px solid #e1e1e1;border-radius:10px;padding:10px 6px;
    background:#fff;cursor:pointer;min-height:54px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
  }
  .cell.blank{border:none;background:transparent;cursor:default}
  .cell.disabled{background:#f0f0f0;color:#aaa;cursor:not-allowed}
  .cell.full{background:#d9534f;color:#fff;cursor:not-allowed;border-color:#d9534f}
  .cell.active{background:#006699;color:#fff;border-color:#006699}

  .small{font-size:12px;margin-top:4px;opacity:.9}
  .note{color:#555;font-size:13px;margin:6px 0 0 0}

  #slots{display:none;margin-top:14px}
  .slot{display:inline-block;margin:6px;padding:9px 12px;border:1px solid #ccc;border-radius:10px;cursor:pointer;background:#fff}
  .slot.booked{background:#ddd;color:#777;cursor:not-allowed}

  #form{display:none;background:#fff;padding:15px;margin:16px auto;max-width:360px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  input{width:100%;padding:10px;margin:6px 0;border:1px solid #ddd;border-radius:10px;font-size:16px}
  button{background:#006699;color:#fff;border:none;padding:12px;border-radius:10px;cursor:pointer;width:100%;font-size:16px}
  button:hover{background:#004466}
  #msg{font-weight:bold;margin:10px 0}
</style>
</head>
<body>
<header>NCD Screening Program – Bidiyah Hospital</header>

<div class="wrap">
  <div class="stats">
    <div class="statBox">المحجوز اليوم: <span id="todayCount">0</span></div>
    <div class="statBox">المحجوز هذا الأسبوع: <span id="weekCount">0</span></div>
    <div class="statBox">إجمالي نافذة الحجز: <span id="totalCount">0</span></div>
  </div>

  <h3>اختر التاريخ (متاح فقط الاثنين والثلاثاء)</h3>
  <div class="note" id="windowNote"></div>

  <div class="months" id="months"></div>

  <div id="slots"></div>

  <div id="form">
    <h3>ادخل بياناتك</h3>
    <input id="inpName" placeholder="الاسم" />
    <input id="inpCivil" placeholder="الرقم المدني" />
    <input id="inpPhone" placeholder="الهاتف" />
    <input id="inpAge" placeholder="العمر" type="number" />
    <button id="btnSave" type="button">تأكيد الحجز</button>
    <div id="msg"></div>
  </div>
</div>

<script>
  // ضع رابط Web App هنا
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxzcRgKTSJBMaKN4MB7EA6_hiU-QLvMe4avDubaQa3R9bbHJZ6IwimFjXX3cem8ikWqoQ/exec";

  // إعدادات المواعيد
  const SLOT_COUNT = 30;
  const SLOT_MINUTES = 10;
  const START_HOUR = 8;

  // نافذة شهرين + تمديد تلقائي (2 + 2 + 2 ...)
  const CHUNK_MONTHS = 2;
  const MAX_MONTHS = 24;

  // عناصر
  const monthsDiv = document.getElementById("months");
  const slotsDiv  = document.getElementById("slots");
  const formDiv   = document.getElementById("form");
  const msgDiv    = document.getElementById("msg");
  const windowNote= document.getElementById("windowNote");

  const inpName  = document.getElementById("inpName");
  const inpCivil = document.getElementById("inpCivil");
  const inpPhone = document.getElementById("inpPhone");
  const inpAge   = document.getElementById("inpAge");
  const btnSave  = document.getElementById("btnSave");

  // بيانات
  let bookings = []; // من الشيت
  let windowMonths = CHUNK_MONTHS;

  let selectedDateISO = null; // YYYY-MM-DD
  let selectedDayKey  = null; // MON/TUE
  let selectedTime    = null; // HH:mm

  const headers = ["السبت","الجمعة","الخميس","الأربعاء","الثلاثاء","الاثنين","الأحد"];


  function pad(n){ return String(n).padStart(2,"0"); }
  function toISO(d){ return d.toISOString().split("T")[0]; }
  function addMonths(d,m){ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; }

  function buildTimes(){
    const times=[];
    let h=START_HOUR, m=0;
    for(let i=0;i<SLOT_COUNT;i++){
      times.push(`${pad(h)}:${pad(m)}`);
      m += SLOT_MINUTES;
      if(m>=60){ m=0; h++; }
    }
    return times;
  }

  function slotKey(dateISO, dayKey, time){
    return `${dateISO}|${dayKey}|${time}`;
  }

  function bookedSet(){
    const set=new Set();
    bookings.forEach(b=>{
      const s = (b.Slot || b.slot || "").toString().trim();
      if(s) set.add(s);
    });
    return set;
  }

  function remainingForDate(dateISO, dayKey, set){
    let booked=0;
    const times = buildTimes();
    for(const t of times){
      if(set.has(slotKey(dateISO, dayKey, t))) booked++;
    }
    return SLOT_COUNT - booked;
  }

  // احصائيات بسيطة
  function calcStats(){
    const today = new Date(); today.setHours(0,0,0,0);
    const todayISO = toISO(today);

    let todayCount=0, weekCount=0;
    bookings.forEach(b=>{
      const d = new Date((b.Date || b.date || "").toString().trim());
      if(!isFinite(d)) return;
      d.setHours(0,0,0,0);

      if((b.Date || b.date || "").toString().trim() === todayISO) todayCount++;

      // أسبوع (آخر 7 أيام)
      const diffDays = Math.floor((today - d) / (1000*60*60*24));
      if(diffDays >= 0 && diffDays <= 7) weekCount++;
    });

    document.getElementById("todayCount").innerText = todayCount;
    document.getElementById("weekCount").innerText  = weekCount;
    document.getElementById("totalCount").innerText = bookings.length;
  }

  // هل نافذة (monthsAhead) ممتلئة بالكامل؟
  function isWindowFull(monthsAhead){
    const start = new Date(); start.setHours(0,0,0,0);
    const end = addMonths(start, monthsAhead);
    end.setHours(23,59,59,999);

    const set = bookedSet();
    const times = buildTimes();

    let total=0, booked=0;

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const dow = d.getDay(); // 0..6
      if(dow===1 || dow===2){
        total += SLOT_COUNT;
        const iso = toISO(d);
        const dayKey = (dow===1) ? "MON" : "TUE";
        for(const t of times){
          if(set.has(slotKey(iso, dayKey, t))) booked++;
        }
      }
    }
    return total>0 && booked>=total;
  }

  function ensureWindow(){
    let m = CHUNK_MONTHS;
    while(m <= MAX_MONTHS){
      if(!isWindowFull(m)){
        windowMonths = m;
        return;
      }
      m += CHUNK_MONTHS;
    }
    windowMonths = MAX_MONTHS;
  }

  // بناء تقويم شهر واحد مع محاذاة صحيحة للأيام
  function renderMonth(monthStart, monthEnd, set){
    const card = document.createElement("div");
    card.className = "monthCard";

    const title = document.createElement("div");
    title.className = "monthTitle";
    title.textContent = monthStart.toLocaleDateString("ar", { month:"long", year:"numeric" });
    card.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";

    // Headers
    headers.forEach(h=>{
      const hd=document.createElement("div");
      hd.className="hdr";
      hd.textContent=h;
      grid.appendChild(hd);
    });

    // فراغات قبل أول يوم بالشهر (حسب getDay)
    const firstDow = monthStart.getDay(); // 0 الأحد .. 6 السبت
    for(let i=0;i<firstDow;i++){
      const blank=document.createElement("div");
      blank.className="cell blank";
      grid.appendChild(blank);
    }

    // أيام الشهر ضمن المدى (وبحد نافذة الحجز)
    for(let d=new Date(monthStart); d<=monthEnd; d.setDate(d.getDate()+1)){
      const iso = toISO(d);
      const dow = d.getDay();

      // فقط داخل نافذة الحجز (من اليوم إلى endWindow)
      const endWindow = addMonths(new Date(), windowMonths);
      endWindow.setHours(23,59,59,999);
      const startWindow = new Date(); startWindow.setHours(0,0,0,0);

      if(d < startWindow || d > endWindow) continue;

      const cell=document.createElement("div");
      cell.className="cell";

      const allowed = (dow===1 || dow===2);
      if(!allowed) cell.classList.add("disabled");

      // احسب المتبقي فقط لو مسموح
      let rem = 0;
      let dayKey = null;
      if(allowed){
        dayKey = (dow===1) ? "MON" : "TUE";
        rem = remainingForDate(iso, dayKey, set);
        if(rem===0) cell.classList.add("full");
      }

      cell.innerHTML = `<div>${d.getDate()}</div>` + (allowed ? `<div class="small">متبقي ${rem}</div>` : "");

      if(allowed && rem>0){
        cell.addEventListener("click", ()=>{
          // فعّل اختيار اليوم
          document.querySelectorAll(".cell.active").forEach(x=>x.classList.remove("active"));
          cell.classList.add("active");

          selectedDateISO = iso;
          selectedDayKey  = dayKey;
          selectedTime    = null;

          renderSlotsForSelected(set);
        });
      }

      grid.appendChild(cell);
    }

    card.appendChild(grid);
    return card;
  }

  // يرسم شهرين (أو أكثر حسب windowMonths) لكن نعرض أول شهرين فقط للواجهة، والنظام يمدد تلقائيًا عند الامتلاء
  function renderCalendar(){
    monthsDiv.innerHTML = "";
    const set = bookedSet();

    windowNote.textContent =
      `نافذة الحجز الحالية: ${windowMonths} شهر (تتوسع تلقائيًا إذا امتلأت بالكامل)`;

    const start = new Date(); start.setHours(0,0,0,0);

    // نعرض شهرين في الواجهة (شهر + الذي بعده)
    const m1 = new Date(start.getFullYear(), start.getMonth(), 1);
    const m2 = new Date(start.getFullYear(), start.getMonth()+1, 1);

    const m1End = new Date(m1.getFullYear(), m1.getMonth()+1, 0);
    const m2End = new Date(m2.getFullYear(), m2.getMonth()+1, 0);

    monthsDiv.appendChild(renderMonth(m1, m1End, set));
    monthsDiv.appendChild(renderMonth(m2, m2End, set));
  }

  function renderSlotsForSelected(set){
    slotsDiv.style.display = "block";
    formDiv.style.display  = "none";
    msgDiv.textContent = "";

    slotsDiv.innerHTML = `<h3>اختر الوقت (${selectedDateISO})</h3>`;

    const times = buildTimes();
    times.forEach(t=>{
      const key = slotKey(selectedDateISO, selectedDayKey, t);
      const isBooked = set.has(key);

      const el = document.createElement("div");
      el.className = "slot" + (isBooked ? " booked" : "");
      el.textContent = t;

      if(!isBooked){
        el.addEventListener("click", ()=>{
          selectedTime = t;
          formDiv.style.display = "block";
          msgDiv.textContent = "";
        });
      }
      slotsDiv.appendChild(el);
    });
  }

  btnSave.addEventListener("click", ()=>{
    msgDiv.textContent = "";

    if(!selectedDateISO || !selectedDayKey || !selectedTime){
      msgDiv.style.color = "red";
      msgDiv.textContent = "اختر التاريخ والوقت أولاً";
      return;
    }

    const Name  = inpName.value.trim();
    const Civil = inpCivil.value.trim();
    const Phone = inpPhone.value.trim();
    const Age   = inpAge.value.trim();

    if(!Name || !Civil || !Phone || !Age){
      msgDiv.style.color = "red";
      msgDiv.textContent = "❌ الرجاء تعبئة جميع الحقول";
      return;
    }

    const params = new URLSearchParams();
    params.append("name", Name);
    params.append("civil", Civil);
    params.append("phone", Phone);
    params.append("age", Age);
    params.append("date", selectedDateISO);
    params.append("day", selectedDayKey);
    params.append("time", selectedTime);
    params.append("slot", slotKey(selectedDateISO, selectedDayKey, selectedTime));

    fetch(SCRIPT_URL, { method:"POST", body: params })
      .then(r=>r.text())
      .then(t=>{
        if(t.includes("❌")){
          msgDiv.style.color = "red";
          msgDiv.textContent = t;
        }else{
          msgDiv.style.color = "green";
          msgDiv.textContent = t;

          // حدّث بيانات الحجوزات محليًا + أعد رسم التقويم
          bookings.push({ Date:selectedDateISO, Day:selectedDayKey, Time:selectedTime, Slot:slotKey(selectedDateISO, selectedDayKey, selectedTime) });

          // لو امتلأت النافذة بالكامل، سيزيد شهرين تلقائيًا
          ensureWindow();
          calcStats();
          renderCalendar();

          formDiv.style.display="none";
          slotsDiv.style.display="none";
        }
      })
      .catch(()=>{
        msgDiv.style.color="red";
        msgDiv.textContent="تعذر الاتصال بالخادم ❌";
      });
  });

  // تحميل الحجوزات
  fetch(SCRIPT_URL)
    .then(r=>r.json())
    .then(data=>{
      bookings = Array.isArray(data) ? data : [];
      ensureWindow();   // لو نافذة الشهرين ممتلئة يمدد تلقائيًا
      calcStats();
      renderCalendar();
    })
    .catch(()=>{
      bookings = [];
      ensureWindow();
      calcStats();
      renderCalendar();
    });
</script>
</body>
</html>

